@using Salvation.Core.ViewModel
@inject IJSRuntime JS

<MudGrid>
    <MudItem xs="12" Class="align-center justify-center">
        <MudText Typo="Typo.h4" Align="Align.Center">Import, Configure, Run!</MudText>
    </MudItem>
    <MudItem xs="12" md="6" xl="4">
        <MudPaper Class="d-flex align-center justify-center mud-width-full py-2 px-2">
            <MudStack Class="mud-width-full">
                <MudText Typo="Typo.h6" Align="Align.Center">Profile</MudText>
                <MudExpansionPanels MultiExpansion="true" Dense="true">
                    <MudExpansionPanel>
                        <TitleContent>
                            <MudStack Row="true" Class="align-center">
                                <MudText>Import in-game profile</MudText>
                            </MudStack>
                        </TitleContent>
                        <ChildContent>
                             <MudStack Class="mud-width-full">
                                <MudText Typo="Typo.subtitle2">To import, download the <MudLink Href="https://www.curseforge.com/wow/addons/simulationcraft" Target="_blank">Simulationcraft Addon</MudLink>, then type <span style="font-family: monospace">/simc</span> in-game.</MudText>
                                <MudTextField T="string" Label="Paste /simc output here" Variant="Variant.Outlined" Text="" Lines="3" />
                                <MudAlert Severity="Severity.Warning">This will override your current profile.</MudAlert>
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true">Import</MudButton>
                            </MudStack>
                        </ChildContent>
                    </MudExpansionPanel>
                    @if (loadingData)
                    {
                        <MudProgressCircular Color="Color.Secondary" Indeterminate="true" />
                    }
                    else if(!loadingData && !string.IsNullOrEmpty(errorMessage))
                    {
                        <MudAlert Severity="Severity.Error">
                            <MudStack Class="mud-width-full">
                                <MudText>@errorMessage</MudText>
                                <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="GetDefaultProfile">Try Again</MudButton>
                            </MudStack>
                        </MudAlert>
                    }
                    else
                    {
                        <MudExpansionPanel Text="Gear">
                            @foreach(var item in data.Items)
                            {
                                <a href="@GenerateWowheadItemLink(item)">@item.Name</a>
                            }
                        </MudExpansionPanel><MudExpansionPanel Text="Playstyle" IsInitiallyExpanded="true">
                            <MudDataGrid T="CastProfileViewModel" Items="@data.Casts" Hover="true" Dense="true" ReadOnly="false" EditMode="DataGridEditMode.Cell" QuickFilter="@playstyleFilter" Height="300px;" ShowColumnOptions="false" SortMode="SortMode.None">
                                <ToolBarContent>
                                    <MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" Immediate="true"
                                              AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                                </ToolBarContent>
                                <Columns>
                                    <Column T="CastProfileViewModel" Field="SpellId" Title="Spell" IsEditable="false">
                                        <CellTemplate>
                                            <a href="@GenerateWowheadSpellLink(context.Item.SpellId)" data-wh-icon-size="tiny">@context.Item.SpellId</a>
                                        </CellTemplate>
                                    </Column>
                                    <Column T="CastProfileViewModel" Field="EfficiencyPercentValue" Title="Efficiency(%)" Filterable="false">
                                        <EditTemplate>
                                            <MudNumericField @bind-Value="context.Item.EfficiencyPercentValue" Mask="@(new PatternMask("000.00"))" Margin="Margin.Dense" Variant="Variant.Text" Adornment="Adornment.End" AdornmentText="%" Min="0" Max="100" Step="5"></MudNumericField>
                                        </EditTemplate>
                                    </Column>
                                    <Column T="CastProfileViewModel" Field="OverhealingPercentValue" Title="Overheal(%)" Filterable="false">
                                        <EditTemplate>
                                            <MudNumericField @bind-Value="context.Item.OverhealingPercentValue" Mask="@(new PatternMask("000.00"))" Margin="Margin.Dense" Variant="Variant.Text" Adornment="Adornment.End" AdornmentText="%" Min="0" Max="100" Step="5"></MudNumericField>
                                        </EditTemplate>
                                    </Column>
                                </Columns>
                            </MudDataGrid>
                        </MudExpansionPanel>
                        <MudExpansionPanel Text="Talents" IsInitiallyExpanded="true">
                            <TalentViewer SelectedTalents=@selectedTalents></TalentViewer>
                        </MudExpansionPanel>
                        <MudExpansionPanel Text="Advanced" IsInitiallyExpanded="true">
                            <MudDataGrid Items="@data.AdvancedSettings" Hover="true" Dense="true" ReadOnly="false" EditMode="DataGridEditMode.Cell" QuickFilter="@advancedFilter" Height="300px;" HorizontalScrollbar="false" ShowColumnOptions="false" SortMode="SortMode.None">
                                <ToolBarContent>
                                    <MudTextField @bind-Value="advancedSearchString" Placeholder="Search" Adornment="Adornment.Start" Immediate="true"
                                              AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                                </ToolBarContent>
                                <Columns>
                                    <Column T="AdvancedSettingsViewModel" Field="SpellId" Title="Spell" IsEditable="false">
                                        <CellTemplate>
                                            <a href="@GenerateWowheadSpellLink(context.Item.SpellId)" data-wh-icon-size="tiny">@context.Item.SpellId</a>
                                        </CellTemplate>
                                    </Column>
                                    <Column T="AdvancedSettingsViewModel" Field="Name" Title="Setting" IsEditable="false">
                                        <CellTemplate>
                                            <MudTooltip Text="@context.Item.Name">
                                                <MudText Typo="Typo.body2" Style="max-width: 130px; overflow: hidden; text-overflow:ellipsis">@context.Item.Name</MudText>
                                            </MudTooltip>
                                        </CellTemplate>
                                    </Column>
                                    <Column T="AdvancedSettingsViewModel" Field="Value" Title="Value" Filterable="false">
                                        <EditTemplate>
                                            <MudNumericField @bind-Value="context.Item.Value" Margin="Margin.Dense" Variant="Variant.Text"></MudNumericField>
                                        </EditTemplate>
                                    </Column>
                                </Columns>
                            </MudDataGrid>
                        </MudExpansionPanel>
                    }
                </MudExpansionPanels>
            </MudStack>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" md="6" xl="8">
        <MudPaper Class="d-flex align-center justify-center mud-width-full py-8 px-2">
            <MudStack Class="mud-width-full">
                <MudText Typo="Typo.h6" Align="Align.Center">Results</MudText>
                <MudButton Variant="Variant.Filled" OnClick="GenerateResults" Color="Color.Primary" FullWidth="true" Size="Size.Small" Disabled="@loadingResults">
                    @if (loadingResults)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                        <MudText>Generating...</MudText>
                    }
                    else
                    {
                        <MudText>Generate Results!</MudText>
                    }
                </MudButton>
                <MudPaper Class="py-1 px-1">
                    @if(modellingResults != null)
                    {
                        <MudStack>
                            <MudStack Row="true" Class="mud-width-full" Justify="Justify.Center">
                                <MudPaper Class="pa-3"><MudTooltip Text="Healing Per Second">@modellingResults.ModelResults.TotalActualHPS.ToString("N0") HPS</MudTooltip></MudPaper>
                                <MudPaper Class="pa-3"><MudTooltip Text="Healing Per Mana Spent">@modellingResults.ModelResults.TotalActualHPM.ToString("N1") HPM</MudTooltip></MudPaper>
                                <MudPaper Class="pa-3"><MudTooltip Text="Time until Out Of Mana">@modellingResults.ModelResults.TimeToOom.ToString("N0")s to OOM</MudTooltip></MudPaper>
                            </MudStack>
                            <MudTabs Centered="true">
                                <MudTabPanel Text="Spell Table" Icon="@Icons.Material.Filled.GridOn">
                                    <MudStack Class="mud-width-full">                                        
                                        <MudTable Dense="true" Items="@modellingResults.ModelResults.SpellCastResults">
                                            <HeaderContent>
                                                <MudTh>Spell</MudTh>
                                                <MudTh><MudTooltip Text="Healing Per Cast Time">HPCT</MudTooltip></MudTh>
                                                <MudTh><MudTooltip Text="Healing Per Mana Spent">HPM</MudTooltip></MudTh>
                                                <MudTh><MudTooltip Text="Casts Per Minute (Maximum CPM)">CPM</MudTooltip></MudTh>
                                                <MudTh><MudTooltip Text="Healing Per Second">HPS</MudTooltip></MudTh>
                                            </HeaderContent>
                                            <RowTemplate>
                                                <MudTd DataLabel="Spell">
                                                    <a href="@GenerateWowheadSpellLink(context.SpellId)" data-wh-icon-size="tiny">@context.SpellName</a>
                                                </MudTd>
                                                <MudTd DataLabel="HPCT">@context.HPCT.ToString("N0")</MudTd>
                                                <MudTd DataLabel="HPM">@context.HPM.ToString("N2")</MudTd>
                                                <MudTd DataLabel="CPM">@context.CastsPerMinute.ToString("N1") (@context.MaximumCastsPerMinute.ToString("N1"))</MudTd>
                                                <MudTd DataLabel="CPM">@context.HPS.ToString("N0")</MudTd>
                                            </RowTemplate>
                                        </MudTable>
                                    </MudStack>
                                </MudTabPanel>
                                <MudTabPanel Text="Journal" Icon="@Icons.Material.Filled.TextSnippet">
                                    <MudStack>
                                        @foreach(var entry in modellingResults.JournalEntries)
                                        {
                                            <MudText Typo="Typo.body2">@entry</MudText>
                                        }
                                    </MudStack>
                                </MudTabPanel>
                            </MudTabs>
                        </MudStack>
                    }
                </MudPaper>
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>